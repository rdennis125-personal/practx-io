<!DOCTYPE html>
<!-- This is a MOCK UI. Replace static data with real API calls later. -->
<!-- Inline sparklines use <svg> paths seeded from mock arrays. -->
<!-- Drawers and modals are pure vanilla JS with focus trap helpers. -->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ELM Command Center | Practx</title>
  <meta name="description" content="Mock ELM command center dashboard for practice operators." />
  <meta property="og:title" content="ELM Command Center | Practx" />
  <meta property="og:description" content="Preview the command center experience a practice will see after signing in." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://practx.io/equipment/elm-command-center.html" />
  <meta property="og:image" content="https://practx.io/assets/logo.png" />
  <meta name="twitter:card" content="summary" />
  <link rel="icon" href="/assets/logo.png" type="image/png" />
  <link rel="stylesheet" href="/assets/styles.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      color-scheme: light;
    }

    body {
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .sparkline-path {
      fill: none;
      stroke-width: 2;
      vector-effect: non-scaling-stroke;
    }

    .sparkline-area {
      fill-opacity: 0.12;
      stroke: none;
    }

    [data-sticky-header] thead th {
      position: sticky;
      top: 0;
      background-color: rgb(248 250 252 / 0.96);
      backdrop-filter: blur(8px);
    }

    .status-pill {
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .drawer-enter {
      transform: translateX(100%);
      opacity: 0;
    }

    .drawer-open {
      transform: translateX(0);
      opacity: 1;
    }

    .modal-enter {
      opacity: 0;
      transform: translateY(16px);
    }

    .modal-open {
      opacity: 1;
      transform: translateY(0);
    }

    .focus-outline:focus {
      outline: 3px solid rgb(59 130 246);
      outline-offset: 2px;
    }

    .toast {
      pointer-events: none;
    }
  </style>
  <script defer src="/assets/js/auth-modal.js"></script>
  <script defer src="/assets/js/entity-forms.js"></script>
</head>
<body class="command-center">
  <header>
    <nav>
      <a class="logo" href="/index.html">
        <img src="/assets/logo.png" alt="Practx logo" height="60" />
      </a>
      <div class="nav-links">
        <ul>
          <li><a href="/practice-management.html">Manage Practices</a></li>
          <li><a href="/equipment-management.html">Manage Equipment</a></li>
          <li><a href="/patient-outreach.html">Connect to Patients</a></li>
          <li><a href="/smile-spa-franchise.html">Expand Access</a></li>
          <li><a href="/practx-service-franchise.html">Ensure Uptime</a></li>
        </ul>
        <a class="button nav-auth-button" data-auth-source="nav-login" href="/logout-complete/">Logout</a>
      </div>
    </nav>
  </header>
  <main>
    <div class="bg-slate-50 text-slate-900">
      <section class="border-b border-slate-200 bg-white/70 backdrop-blur">
        <div class="mx-auto flex max-w-7xl flex-col gap-6 px-4 py-10 sm:px-6 lg:px-8">
          <div class="flex flex-col justify-between gap-6 md:flex-row md:items-center">
            <div>
              <div class="flex items-center gap-3 text-sm font-medium text-slate-500" aria-label="Breadcrumb">
                <span>Equipment</span>
                <span aria-hidden="true">‚Ä∫</span>
                <span>Command Center</span>
              </div>
              <div class="mt-4 flex items-center gap-3 text-slate-900">
                <div class="flex h-10 w-10 items-center justify-center rounded-full bg-slate-900 text-white text-lg font-semibold">P</div>
                <div>
                  <p class="text-xs uppercase tracking-widest text-slate-400">Practx</p>
                  <h1 class="text-2xl font-semibold text-slate-900 sm:text-3xl">ELM Command Center</h1>
                </div>
              </div>
            </div>
            <div class="grid gap-2 text-right text-sm text-slate-500">
              <p><span class="font-semibold text-slate-900">Practice:</span> <span id="practice-name" class="font-medium"></span></p>
              <p><span class="font-semibold text-slate-900">Last refreshed:</span> <span id="last-refreshed"></span></p>
            </div>
          </div>
          <div class="flex flex-wrap gap-3">
            <button type="button" data-open-drawer="locations" class="focus-outline inline-flex items-center gap-2 rounded-full border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:border-slate-400 hover:text-slate-900">
              <span aria-hidden="true">üè¢</span> Configure Rooms/Spaces
            </button>
            <button type="button" data-open-drawer="providers" class="focus-outline inline-flex items-center gap-2 rounded-full border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:border-slate-400 hover:text-slate-900">
              <span aria-hidden="true">ü§ù</span> Approved Providers
            </button>
            <button type="button" data-open-drawer="service-windows" class="focus-outline inline-flex items-center gap-2 rounded-full border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:border-slate-400 hover:text-slate-900">
              <span aria-hidden="true">üïí</span> Service Windows
            </button>
          </div>
        </div>
      </section>

      <section class="mx-auto max-w-7xl px-4 py-10 sm:px-6 lg:px-8">
        <div class="grid gap-6 lg:grid-cols-3">
          <div class="lg:col-span-2">
            <div class="grid gap-4 sm:grid-cols-2 xl:grid-cols-3" id="kpi-grid" aria-live="polite"></div>
          </div>
          <div class="grid gap-4">
            <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
              <h3 class="text-sm font-semibold text-slate-700">Spend vs Forecast</h3>
              <div class="mt-4 flex items-center justify-between text-xs text-slate-500">
                <span class="inline-flex items-center gap-2"><span class="h-2 w-2 rounded-full bg-blue-500"></span>Spend</span>
                <span class="inline-flex items-center gap-2"><span class="h-2 w-2 rounded-full bg-emerald-500"></span>Forecast</span>
              </div>
              <div id="trend-spend" class="mt-4"></div>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
              <h3 class="text-sm font-semibold text-slate-700">Incidents Over Time</h3>
              <div id="trend-incidents" class="mt-4"></div>
            </div>
          </div>
        </div>
      </section>

      <section class="mx-auto max-w-7xl px-4 pb-14 sm:px-6 lg:px-8" id="assets-section">
        <div class="rounded-3xl border border-slate-200 bg-white/70 p-6 shadow-sm backdrop-blur">
          <div class="flex flex-col gap-4 border-b border-slate-200 pb-4 md:flex-row md:items-end md:justify-between">
            <div>
              <h2 class="text-xl font-semibold text-slate-900">Active Assets</h2>
              <p class="text-sm text-slate-500">Monitor uptime, spend, and service readiness across rooms and shared spaces.</p>
            </div>
            <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
              <label class="flex items-center gap-2 text-sm text-slate-500">
                <span class="sr-only">Search assets</span>
                <svg class="h-4 w-4 text-slate-400" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27a6.471 6.471 0 001.57-4.23A6.5 6.5 0 109.5 16a6.47 6.47 0 004.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0A4.5 4.5 0 1114 9.5 4.505 4.505 0 019.5 14z"/></svg>
                <input id="asset-search" type="search" placeholder="Search by asset, type, or room/space" class="w-full rounded-full border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 sm:w-72" />
              </label>
              <label class="text-sm text-slate-500">
                <span class="sr-only">Filter by status</span>
                <select id="status-filter" class="focus-outline rounded-full border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200">
                  <option value="All">All Statuses</option>
                  <option value="Healthy">Healthy</option>
                  <option value="Attention">Attention</option>
                  <option value="Down">Down</option>
                  <option value="Unknown">Unknown</option>
                  <option value="Sunset">Sunset</option>
                </select>
              </label>
              <div class="inline-flex overflow-hidden rounded-full border border-slate-300 text-sm font-medium text-slate-600">
                <button type="button" data-sort="spendYtd" class="focus-outline flex items-center gap-1 border-r border-slate-300 bg-white px-3 py-2 hover:bg-slate-100" aria-label="Sort by spend">
                  Spend YTD
                  <span aria-hidden="true" class="sort-indicator" data-sort-indicator="spendYtd">‚Üï</span>
                </button>
                <button type="button" data-sort="nextService" class="focus-outline flex items-center gap-1 bg-white px-3 py-2 hover:bg-slate-100" aria-label="Sort by next service date">
                  Next Service
                  <span aria-hidden="true" class="sort-indicator" data-sort-indicator="nextService">‚Üï</span>
                </button>
              </div>
              <button type="button" data-asset-add class="focus-outline inline-flex items-center gap-2 rounded-full border border-blue-200 bg-blue-50 px-4 py-2 text-sm font-semibold text-blue-700 transition hover:border-blue-300 hover:bg-blue-100">
                <span aria-hidden="true">Ôºã</span>
                Add asset
              </button>
            </div>
          </div>

          <div id="asset-detail" class="mt-6 hidden rounded-2xl border border-slate-200 bg-white p-6 shadow-sm"></div>

          <div class="mt-6 overflow-x-auto" data-sticky-header>
            <table class="min-w-full divide-y divide-slate-200 text-left text-sm text-slate-600" aria-describedby="assets-section">
              <thead class="text-xs uppercase tracking-widest text-slate-500">
                <tr>
                  <th scope="col" class="px-4 py-3">Asset ID</th>
                  <th scope="col" class="px-4 py-3">Type / Model</th>
                  <th scope="col" class="px-4 py-3">Room/Space</th>
                  <th scope="col" class="px-4 py-3">Status</th>
                  <th scope="col" class="px-4 py-3">Next Service</th>
                  <th scope="col" class="px-4 py-3">Warranty</th>
                  <th scope="col" class="px-4 py-3 text-right">Spend YTD</th>
                  <th scope="col" class="px-4 py-3 text-right">Actions</th>
                </tr>
              </thead>
              <tbody id="assets-body" class="divide-y divide-slate-100 bg-white" aria-live="polite"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </main>
  <footer class="bg-white">
    <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8 text-sm text-slate-500">¬© Practx</div>
  </footer>

  <div id="drawer-locations" class="pointer-events-none fixed inset-0 z-40 hidden" data-drawer="locations" aria-hidden="true">
    <div class="absolute inset-0 bg-slate-900/40 opacity-0 transition-opacity" data-drawer-backdrop></div>
    <div class="drawer-enter absolute right-0 top-0 h-full w-full max-w-xl transform transition-all" data-drawer-panel>
      <div class="flex h-full flex-col bg-white shadow-2xl">
        <div class="flex items-start justify-between border-b border-slate-200 px-6 py-5">
          <div>
            <h2 class="text-lg font-semibold text-slate-900">Rooms/Spaces</h2>
            <p class="text-sm text-slate-500">Manage operatory rooms and shared spaces.</p>
          </div>
          <button type="button" class="focus-outline rounded-full border border-transparent p-2 text-slate-400 hover:text-slate-600" data-close-drawer>
            <span class="sr-only">Close</span>
            <svg viewBox="0 0 24 24" class="h-5 w-5" aria-hidden="true"><path fill="currentColor" d="M18.3 5.71a1 1 0 00-1.41 0L12 10.59 7.11 5.7A1 1 0 105.7 7.11L10.59 12l-4.9 4.89a1 1 0 101.41 1.41L12 13.41l4.89 4.9a1 1 0 001.41-1.42L13.41 12l4.9-4.89a1 1 0 000-1.4z"/></svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto px-6 py-6" id="locations-drawer-content"></div>
      </div>
    </div>
  </div>

  <div id="drawer-providers" class="pointer-events-none fixed inset-0 z-40 hidden" data-drawer="providers" aria-hidden="true">
    <div class="absolute inset-0 bg-slate-900/40 opacity-0 transition-opacity" data-drawer-backdrop></div>
    <div class="drawer-enter absolute right-0 top-0 h-full w-full max-w-3xl transform transition-all" data-drawer-panel>
      <div class="flex h-full flex-col bg-white shadow-2xl">
        <div class="flex items-start justify-between border-b border-slate-200 px-6 py-5">
          <div>
            <h2 class="text-lg font-semibold text-slate-900">Approved Service Providers</h2>
            <p class="text-sm text-slate-500">Coordinate preferred vendor coverage by priority.</p>
          </div>
          <button type="button" class="focus-outline rounded-full border border-transparent p-2 text-slate-400 hover:text-slate-600" data-close-drawer>
            <span class="sr-only">Close</span>
            <svg viewBox="0 0 24 24" class="h-5 w-5" aria-hidden="true"><path fill="currentColor" d="M18.3 5.71a1 1 0 00-1.41 0L12 10.59 7.11 5.7A1 1 0 105.7 7.11L10.59 12l-4.9 4.89a1 1 0 101.41 1.41L12 13.41l4.89 4.9a1 1 0 001.41-1.42L13.41 12l4.9-4.89a1 1 0 000-1.4z"/></svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto px-6 py-6" id="providers-drawer-content"></div>
      </div>
    </div>
  </div>

  <div id="drawer-service-windows" class="pointer-events-none fixed inset-0 z-40 hidden" data-drawer="service-windows" aria-hidden="true">
    <div class="absolute inset-0 bg-slate-900/40 opacity-0 transition-opacity" data-drawer-backdrop></div>
    <div class="drawer-enter absolute right-0 top-0 h-full w-full max-w-3xl transform transition-all" data-drawer-panel>
      <div class="flex h-full flex-col bg-white shadow-2xl">
        <div class="flex items-start justify-between border-b border-slate-200 px-6 py-5">
          <div>
            <h2 class="text-lg font-semibold text-slate-900">Service Windows</h2>
            <p class="text-sm text-slate-500">Define when technicians can access each room/space.</p>
          </div>
          <button type="button" class="focus-outline rounded-full border border-transparent p-2 text-slate-400 hover:text-slate-600" data-close-drawer>
            <span class="sr-only">Close</span>
            <svg viewBox="0 0 24 24" class="h-5 w-5" aria-hidden="true"><path fill="currentColor" d="M18.3 5.71a1 1 0 00-1.41 0L12 10.59 7.11 5.7A1 1 0 105.7 7.11L10.59 12l-4.9 4.89a1 1 0 101.41 1.41L12 13.41l4.89 4.9a1 1 0 001.41-1.42L13.41 12l4.9-4.89a1 1 0 000-1.4z"/></svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto px-6 py-6" id="service-windows-drawer-content"></div>
      </div>
    </div>
  </div>

  <div id="drawer-asset" class="pointer-events-none fixed inset-0 z-40 hidden" data-drawer="asset-management" aria-hidden="true">
    <div class="absolute inset-0 bg-slate-900/40 opacity-0 transition-opacity" data-drawer-backdrop></div>
    <div class="drawer-enter absolute right-0 top-0 h-full w-full max-w-3xl transform transition-all" data-drawer-panel>
      <div class="flex h-full flex-col bg-white shadow-2xl" id="asset-drawer-root"></div>
    </div>
  </div>

  <div id="downtime-modal" class="pointer-events-none fixed inset-0 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="downtime-title">
    <div class="absolute inset-0 bg-slate-900/40 opacity-0 transition-opacity" data-modal-backdrop></div>
    <div class="modal-enter relative mx-auto mt-16 w-full max-w-xl rounded-3xl bg-white p-6 shadow-2xl transition-all">
      <div class="flex items-start justify-between">
        <div>
          <h2 id="downtime-title" class="text-xl font-semibold text-slate-900">Record downtime / emergency service</h2>
          <p class="text-sm text-slate-500">Log the event and notify your vendor team.</p>
        </div>
        <button type="button" class="focus-outline rounded-full border border-transparent p-2 text-slate-400 hover:text-slate-600" data-close-modal>
          <span class="sr-only">Close</span>
          <svg viewBox="0 0 24 24" class="h-5 w-5" aria-hidden="true"><path fill="currentColor" d="M18.3 5.71a1 1 0 00-1.41 0L12 10.59 7.11 5.7A1 1 0 105.7 7.11L10.59 12l-4.9 4.89a1 1 0 101.41 1.41L12 13.41l4.89 4.9a1 1 0 001.41-1.42L13.41 12l4.9-4.89a1 1 0 000-1.4z"/></svg>
        </button>
      </div>
      <form id="downtime-form" class="mt-6 space-y-5">
        <input type="hidden" name="assetId" />
        <div class="grid gap-4 sm:grid-cols-2">
          <label class="text-sm font-medium text-slate-600">Start time
            <input type="datetime-local" name="startTime" required class="mt-1 w-full rounded-2xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" />
          </label>
          <label class="text-sm font-medium text-slate-600">Impact level
            <select name="impact" class="mt-1 w-full rounded-2xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200">
              <option value="Minor">Minor</option>
              <option value="Room down">Room down</option>
              <option value="Practice impacted">Practice impacted</option>
            </select>
          </label>
        </div>
        <label class="text-sm font-medium text-slate-600">Symptom / description
          <textarea name="symptom" rows="3" required class="mt-1 w-full rounded-2xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200"></textarea>
        </label>
        <fieldset class="space-y-3 rounded-2xl border border-slate-200 p-4">
          <legend class="text-sm font-semibold text-slate-700">Notifications</legend>
          <label class="flex items-center gap-3 text-sm font-medium text-slate-600">
            <input type="checkbox" name="emergency" class="h-4 w-4 rounded border-slate-300 text-blue-500 focus:ring-blue-200" />
            Request emergency service dispatch
          </label>
          <label class="flex items-center gap-3 text-sm font-medium text-slate-600">
            <input type="checkbox" name="notify" class="h-4 w-4 rounded border-slate-300 text-blue-500 focus:ring-blue-200" />
            Notify preferred provider automatically
          </label>
        </fieldset>
        <div class="flex justify-end gap-3">
          <button type="button" data-close-modal class="focus-outline rounded-full border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100">Cancel</button>
          <button type="submit" class="focus-outline inline-flex items-center gap-2 rounded-full bg-blue-600 px-5 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700">
            Submit incident
          </button>
        </div>
      </form>
    </div>
  </div>

  <div id="toast" class="toast fixed bottom-6 right-6 hidden rounded-full bg-slate-900 px-4 py-2 text-sm font-medium text-white shadow-lg" role="status" aria-live="polite"></div>

  <script id="mock-data" type="application/json">
    {
      "practiceOverview": {
        "practiceName": "Summit Dental Care",
        "kpis": {
          "mtdSpend": 18320,
          "ytdSpend": 212450,
          "forecast30": 28450,
          "forecast90": 76420,
          "openWorkOrders": 6,
          "avgDowntime": 2.3,
          "slaHitRate": 0.94
        },
        "trends": {
          "spendVsForecast": {
            "labels": ["Aug", "Sep", "Oct", "Nov", "Dec", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul"],
            "spend": [16200, 17540, 18980, 20400, 21450, 18220, 19340, 20560, 21900, 23120, 22450, 18320],
            "forecast": [15800, 16900, 18600, 19800, 21000, 18000, 18800, 20100, 21500, 22600, 23200, 19000]
          },
          "incidents": {
            "labels": ["Aug", "Sep", "Oct", "Nov", "Dec", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul"],
            "values": [3, 2, 4, 5, 4, 3, 6, 5, 4, 3, 2, 4]
          }
        },
        "config": {
          "locations": [
            { "id": "OP-1", "name": "Operatory 1", "notes": "Primary hygiene bay" },
            { "id": "OP-2", "name": "Operatory 2", "notes": "Doctor's procedure room" },
            { "id": "OP-3", "name": "Operatory 3", "notes": "Implant suite" },
            { "id": "IMG-1", "name": "Imaging Lab", "notes": "CBCT and pano" },
            { "id": "STER-1", "name": "Central Sterilization", "notes": "Shared between floors" },
            { "id": "MECH-1", "name": "Mechanical Room", "notes": "Compressors and vacuums" }
          ],
          "providers": [
            { "id": "prov-1", "name": "Delta Biomedical", "priority": 1, "coverage": "Same-day", "terms": "NTE $1,200 per visit" },
            { "id": "prov-2", "name": "Vantage Dental Service", "priority": 2, "coverage": "Next-day", "terms": "Annual retainer $4,800" },
            { "id": "prov-3", "name": "Praxis Imaging", "priority": 3, "coverage": "72-hour", "terms": "Per-call $450" }
          ],
          "serviceWindows": [
            {
              "id": "svc-1",
              "label": "Weeknights 6‚Äì9pm",
              "rrule": "FREQ=WEEKLY;BYDAY=MO,TU,WE,TH;BYHOUR=18;BYMINUTE=0;BYSECOND=0",
              "blackouts": ["2024-07-04", "2024-11-28"]
            },
            {
              "id": "svc-2",
              "label": "Saturdays 8am‚Äì1pm",
              "rrule": "FREQ=WEEKLY;BYDAY=SA;BYHOUR=8;BYMINUTE=0;BYSECOND=0;UNTIL=20241231T130000Z",
              "blackouts": ["2024-12-21", "2024-12-28"]
            },
            {
              "id": "svc-3",
              "label": "Quarterly Deep Clean",
              "rrule": "FREQ=MONTHLY;INTERVAL=3;BYDAY=SA;BYSETPOS=2;BYHOUR=7;BYMINUTE=0;BYSECOND=0",
              "blackouts": ["2024-10-12"]
            }
          ]
        }
      },
      "assets": [
        {
          "id": "CHAIR-101",
          "type": "Operatory Chair",
          "model": "A-dec 500",
          "locationId": "OP-1",
          "status": "Healthy",
          "nextService": "2024-07-12",
          "warranty": "2026-01-01",
          "spendYtd": 2350,
          "trending": [72, 74, 73, 75, 76, 77, 78, 79, 78, 77, 78, 80],
          "spend": { "ytd": 2350, "mtd": 420 },
          "forecast": { "30": 320, "90": 840 },
          "playbook": ["Inspect upholstery for tears", "Calibrate headrest and arm sensors", "Confirm foot control response"],
          "history": [
            { "date": "2024-05-06", "summary": "Preventive maintenance completed", "type": "Service" },
            { "date": "2024-02-14", "summary": "Hydraulic fluid topped off", "type": "Maintenance" }
          ],
          "serviceProviderIds": ["prov-1"],
          "serviceWindowIds": ["svc-1"],
          "sunsetDate": null
        },
        {
          "id": "DELIV-204",
          "type": "Delivery Unit",
          "model": "Midmark Elevance",
          "locationId": "OP-2",
          "status": "Attention",
          "nextService": "2024-06-28",
          "warranty": "2025-09-30",
          "spendYtd": 4120,
          "trending": [65, 66, 67, 66, 64, 62, 63, 61, 62, 63, 64, 63],
          "spend": { "ytd": 4120, "mtd": 780 },
          "forecast": { "30": 560, "90": 1380 },
          "playbook": ["Flush waterlines weekly", "Replace O-rings quarterly", "Verify air pressure limits"],
          "history": [
            { "date": "2024-05-22", "summary": "Handpiece coupler replaced", "type": "Repair" },
            { "date": "2024-03-18", "summary": "Tubing leak detected", "type": "Incident" }
          ],
          "serviceProviderIds": ["prov-1", "prov-2"],
          "serviceWindowIds": ["svc-1", "svc-2"],
          "sunsetDate": null
        },
        {
          "id": "IMG-330",
          "type": "CBCT Scanner",
          "model": "Planmeca ProMax",
          "locationId": "IMG-1",
          "status": "Healthy",
          "nextService": "2024-08-05",
          "warranty": "2027-03-15",
          "spendYtd": 15240,
          "trending": [88, 87, 88, 89, 90, 89, 90, 91, 92, 93, 92, 91],
          "spend": { "ytd": 15240, "mtd": 1120 },
          "forecast": { "30": 2100, "90": 5400 },
          "playbook": ["Warm-up cycle before first scan", "Run QA phantom weekly", "Archive scans to PACS"],
          "history": [
            { "date": "2024-04-16", "summary": "Calibration verification passed", "type": "Service" },
            { "date": "2024-01-09", "summary": "Firmware updated to v3.2", "type": "Upgrade" }
          ],
          "serviceProviderIds": ["prov-3"],
          "serviceWindowIds": ["svc-2"],
          "sunsetDate": null
        },
        {
          "id": "STER-88",
          "type": "Sterilizer",
          "model": "Tuttnauer EZ10",
          "locationId": "STER-1",
          "status": "Attention",
          "nextService": "2024-06-20",
          "warranty": "2024-12-31",
          "spendYtd": 6840,
          "trending": [58, 59, 57, 60, 61, 62, 60, 58, 59, 61, 62, 60],
          "spend": { "ytd": 6840, "mtd": 980 },
          "forecast": { "30": 720, "90": 1680 },
          "playbook": ["Document spore test results", "Drain reservoir weekly", "Inspect door gasket"],
          "history": [
            { "date": "2024-05-30", "summary": "Cycle aborted due to pressure drop", "type": "Incident" },
            { "date": "2024-02-02", "summary": "Heating element replaced", "type": "Repair" }
          ],
          "serviceProviderIds": ["prov-2"],
          "serviceWindowIds": ["svc-1", "svc-3"],
          "sunsetDate": null
        },
        {
          "id": "COMP-14",
          "type": "Compressor",
          "model": "TechWest Ultimate",
          "locationId": "MECH-1",
          "status": "Healthy",
          "nextService": "2024-09-01",
          "warranty": "2025-04-01",
          "spendYtd": 4380,
          "trending": [76, 75, 74, 73, 72, 74, 75, 74, 76, 77, 78, 79],
          "spend": { "ytd": 4380, "mtd": 360 },
          "forecast": { "30": 480, "90": 1240 },
          "playbook": ["Check oil level bi-weekly", "Purge moisture traps", "Verify dryer set point"],
          "history": [
            { "date": "2024-03-12", "summary": "Filter kit replaced", "type": "Maintenance" }
          ],
          "serviceProviderIds": ["prov-1"],
          "serviceWindowIds": ["svc-2", "svc-3"],
          "sunsetDate": null
        },
        {
          "id": "VAC-07",
          "type": "Vacuum System",
          "model": "Dentsply DryVac",
          "locationId": "MECH-1",
          "status": "Down",
          "nextService": "2024-06-05",
          "warranty": null,
          "spendYtd": 8120,
          "trending": [44, 42, 40, 38, 36, 35, 34, 33, 32, 31, 30, 29],
          "spend": { "ytd": 8120, "mtd": 1680 },
          "forecast": { "30": 2200, "90": 5100 },
          "playbook": ["Verify suction at each operatory", "Clean debris filters daily", "Escalate if kPa < 12"],
          "history": [
            { "date": "2024-06-02", "summary": "Emergency shutdown due to overheating", "type": "Incident" },
            { "date": "2024-05-08", "summary": "Bearing vibration detected", "type": "Alert" }
          ],
          "serviceProviderIds": ["prov-2"],
          "serviceWindowIds": ["svc-3"],
          "sunsetDate": null
        },
        {
          "id": "XRAY-21",
          "type": "Intraoral X-ray",
          "model": "Carestream CS 2200",
          "locationId": "OP-3",
          "status": "Healthy",
          "nextService": "2024-11-18",
          "warranty": "2026-05-30",
          "spendYtd": 1980,
          "trending": [81, 82, 83, 83, 84, 85, 85, 86, 86, 87, 87, 88],
          "spend": { "ytd": 1980, "mtd": 260 },
          "forecast": { "30": 340, "90": 960 },
          "playbook": ["Replace arm tension springs annually", "Clean collimator surfaces", "Document QA exposures"],
          "history": [
            { "date": "2024-04-02", "summary": "Arm alignment adjusted", "type": "Maintenance" }
          ],
          "serviceProviderIds": ["prov-3"],
          "serviceWindowIds": ["svc-2"],
          "sunsetDate": null
        },
        {
          "id": "LASER-05",
          "type": "Soft Tissue Laser",
          "model": "Biolase Epic X",
          "locationId": "OP-2",
          "status": "Healthy",
          "nextService": "2024-10-09",
          "warranty": "2025-12-15",
          "spendYtd": 1560,
          "trending": [74, 75, 74, 73, 72, 74, 76, 78, 79, 78, 77, 78],
          "spend": { "ytd": 1560, "mtd": 180 },
          "forecast": { "30": 210, "90": 640 },
          "playbook": ["Replace fiber tips daily", "Verify aiming beam calibration", "Store in locked case"],
          "history": [
            { "date": "2024-03-05", "summary": "Laser calibration certification", "type": "Compliance" }
          ],
          "serviceProviderIds": ["prov-1", "prov-3"],
          "serviceWindowIds": ["svc-1"],
          "sunsetDate": null
        },
        {
          "id": "ITR-17",
          "type": "Intraoral Scanner",
          "model": "iTero Element 5D",
          "locationId": "IMG-1",
          "status": "Attention",
          "nextService": "2024-07-25",
          "warranty": "2025-11-04",
          "spendYtd": 5230,
          "trending": [79, 78, 77, 76, 76, 75, 74, 73, 73, 72, 71, 70],
          "spend": { "ytd": 5230, "mtd": 620 },
          "forecast": { "30": 780, "90": 1680 },
          "playbook": ["Update software monthly", "Sanitize wand sleeves", "Monitor calibration logs"],
          "history": [
            { "date": "2024-05-18", "summary": "Scanner overheating flagged", "type": "Alert" }
          ],
          "serviceProviderIds": ["prov-2", "prov-3"],
          "serviceWindowIds": ["svc-2", "svc-3"],
          "sunsetDate": null
        },
        {
          "id": "HAND-62",
          "type": "Handpiece Set",
          "model": "KaVo MASTERtorque",
          "locationId": "STER-1",
          "status": "Unknown",
          "nextService": null,
          "warranty": "2024-09-09",
          "spendYtd": 1120,
          "trending": [60, 59, 58, 60, 61, 59, 58, 57, 56, 55, 55, 54],
          "spend": { "ytd": 1120, "mtd": 140 },
          "forecast": { "30": 180, "90": 420 },
          "playbook": ["Track sterilization cycles", "Lubricate before autoclave", "Replace turbines quarterly"],
          "history": [
            { "date": "2024-02-27", "summary": "Awaiting serial number verification", "type": "Task" }
          ]
        },
        {
          "id": "MON-02",
          "type": "Patient Monitor",
          "model": "Philips IntelliVue",
          "locationId": "OP-1",
          "status": "Healthy",
          "nextService": "2024-12-01",
          "warranty": "2026-04-18",
          "spendYtd": 2640,
          "trending": [85, 84, 83, 82, 83, 84, 85, 86, 86, 87, 88, 89],
          "spend": { "ytd": 2640, "mtd": 240 },
          "forecast": { "30": 310, "90": 920 },
          "playbook": ["Run self-test weekly", "Document sensor replacements", "Verify BP cuff rotation"],
          "history": [
            { "date": "2024-04-22", "summary": "ECG lead replaced", "type": "Maintenance" }
          ]
        }
      ]
    }
  </script>

  <script>
    const rawData = document.getElementById('mock-data').textContent;
    const state = JSON.parse(rawData);
    state.incidents = [];
    const uiState = {
      activeAssetId: null,
      activeAssetTab: 'profile',
      assetSearch: '',
      assetStatusFilter: 'All',
      assetSort: { key: null, direction: 'asc' },
      assetDrawer: { mode: null, assetId: null },
      editing: {
        locations: null,
        providers: null,
        serviceWindows: null
      },
      adding: {
        locations: false,
        providers: false,
        serviceWindows: false
      }
    };

    const refs = {};
    const focusTrap = (() => {
      let active = null;
      const getFocusable = (container) => {
        return Array.from(container.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])')).filter(el => !el.hasAttribute('disabled') && !el.getAttribute('aria-hidden'));
      };
      const handleKeydown = (event) => {
        if (!active) return;
        if (event.key === 'Tab') {
          const { first, last } = active;
          if (event.shiftKey && document.activeElement === first) {
            event.preventDefault();
            last.focus();
          } else if (!event.shiftKey && document.activeElement === last) {
            event.preventDefault();
            first.focus();
          }
        }
        if (event.key === 'Escape') {
          if (typeof active.onEscape === 'function') {
            active.onEscape();
          }
        }
      };
      return {
        trap(container, onEscape) {
          const focusable = getFocusable(container);
          if (focusable.length) {
            focusable[0].focus();
          }
          active = { container, first: focusable[0], last: focusable[focusable.length - 1], onEscape };
          container.addEventListener('keydown', handleKeydown);
          document.addEventListener('keydown', handleKeydown);
        },
        release() {
          if (!active) return;
          active.container.removeEventListener('keydown', handleKeydown);
          document.removeEventListener('keydown', handleKeydown);
          active = null;
        }
      };
    })();

    function formatCurrency(value) {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(value);
    }

    function formatNumber(value, options = {}) {
      return new Intl.NumberFormat('en-US', options).format(value);
    }

    function formatPercent(value) {
      return `${Math.round(value * 100)}%`;
    }

    function formatHours(value) {
      return `${value.toFixed(1)} hrs`;
    }

    function formatDate(value) {
      if (!value) return '‚Äî';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return value;
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function toDateInputValue(value) {
      if (!value) return '';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return value;
      return date.toISOString().slice(0, 10);
    }

    function relativeTimeFromNow(dateString) {
      const date = new Date(dateString);
      if (Number.isNaN(date.getTime())) return 'Unknown';
      const now = new Date();
      const diff = Math.abs(now - date);
      const days = Math.round(diff / (1000 * 60 * 60 * 24));
      if (days === 0) return 'Today';
      if (days === 1) return '1 day ago';
      if (days < 7) return `${days} days ago`;
      const weeks = Math.round(days / 7);
      if (weeks < 5) return `${weeks} wk${weeks > 1 ? 's' : ''} ago`;
      const months = Math.round(days / 30);
      return `${months} mo${months > 1 ? 's' : ''} ago`;
    }

    function buildSparklinePath(values, width = 240, height = 80, padding = 6) {
      if (!values.length) return '';
      const min = Math.min(...values);
      const max = Math.max(...values);
      const range = max - min || 1;
      const step = (width - padding * 2) / (values.length - 1 || 1);
      return values
        .map((value, index) => {
          const x = padding + index * step;
          const y = height - padding - ((value - min) / range) * (height - padding * 2);
          return `${index === 0 ? 'M' : 'L'}${x.toFixed(2)},${y.toFixed(2)}`;
        })
        .join(' ');
    }

    function buildSparklineArea(values, width = 240, height = 80, padding = 6) {
      if (!values.length) return '';
      const path = buildSparklinePath(values, width, height, padding);
      if (!path) return '';
      const coordinates = path.split(' ').map(point => point.substring(1).split(',').map(Number));
      const last = coordinates[coordinates.length - 1];
      const first = coordinates[0];
      const baselineY = height - padding;
      return `${path} L${last[0]},${baselineY} L${first[0]},${baselineY} Z`;
    }

    function generateTrendingFromStatus(status) {
      const base = (() => {
        switch (status) {
          case 'Healthy':
            return 80;
          case 'Attention':
            return 65;
          case 'Down':
            return 40;
          case 'Sunset':
            return 35;
          default:
            return 72;
        }
      })();
      return Array.from({ length: 12 }, (_, index) => {
        const oscillation = Math.sin(index / 2) * 4;
        const drift = status === 'Down'
          ? -index * 0.8
          : status === 'Attention'
            ? -index * 0.3
            : status === 'Sunset'
              ? -index * 0.5
              : index * 0.2;
        const value = base + oscillation + drift;
        return Math.max(10, Math.min(100, Math.round(value)));
      });
    }

    function renderKPIs() {
      const kpiGrid = document.getElementById('kpi-grid');
      const kpis = state.practiceOverview.kpis;
      const items = [
        { label: 'MTD Spend', value: formatCurrency(kpis.mtdSpend) },
        { label: 'YTD Spend', value: formatCurrency(kpis.ytdSpend) },
        { label: 'Forecast', value: `${formatCurrency(kpis.forecast30)} / ${formatCurrency(kpis.forecast90)}<span class="text-xs text-slate-500"> (30 / 90 days)</span>` },
        { label: 'Open Work Orders', value: formatNumber(kpis.openWorkOrders) },
        { label: 'Avg Downtime', value: formatHours(kpis.avgDowntime) },
        { label: 'SLA Hit Rate', value: formatPercent(kpis.slaHitRate) }
      ];
      kpiGrid.innerHTML = items
        .map((item) => {
          return `<article class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md">
            <p class="text-xs font-medium uppercase tracking-wider text-slate-500">${item.label}</p>
            <p class="mt-3 text-2xl font-semibold text-slate-900">${item.value}</p>
          </article>`;
        })
        .join('');
    }

    function renderTrends() {
      const spendContainer = document.getElementById('trend-spend');
      const incidentsContainer = document.getElementById('trend-incidents');
      const spendData = state.practiceOverview.trends.spendVsForecast;
      const incidentsData = state.practiceOverview.trends.incidents;

      const width = 260;
      const height = 90;
      const spendPath = buildSparklinePath(spendData.spend, width, height);
      const forecastPath = buildSparklinePath(spendData.forecast, width, height);
      spendContainer.innerHTML = `<svg viewBox="0 0 ${width} ${height}" class="h-24 w-full" role="img" aria-label="Spend vs forecast trend">
        <desc>Monthly spend and forecast comparison for the last 12 periods</desc>
        <path d="${buildSparklineArea(spendData.spend, width, height)}" class="sparkline-area fill-blue-500/20"></path>
        <path d="${spendPath}" class="sparkline-path stroke-blue-500"></path>
        <path d="${forecastPath}" class="sparkline-path stroke-emerald-500"></path>
      </svg>`;

      const incidentsPath = buildSparklinePath(incidentsData.values, width, height);
      incidentsContainer.innerHTML = `<svg viewBox="0 0 ${width} ${height}" class="h-24 w-full" role="img" aria-label="Incidents trend">
        <desc>Monthly incidents recorded for the last 12 periods</desc>
        <path d="${buildSparklineArea(incidentsData.values, width, height)}" class="sparkline-area fill-rose-500/20"></path>
        <path d="${incidentsPath}" class="sparkline-path stroke-rose-500"></path>
      </svg>`;
    }

    function statusClasses(status) {
      switch (status) {
        case 'Healthy':
          return 'status-pill bg-emerald-100 text-emerald-700';
        case 'Attention':
          return 'status-pill bg-amber-100 text-amber-700';
        case 'Down':
          return 'status-pill bg-rose-100 text-rose-700';
        case 'Sunset':
          return 'status-pill bg-slate-200 text-slate-600';
        default:
          return 'status-pill bg-slate-200 text-slate-700';
      }
    }

    function getLocationName(id) {
      if (!id) return 'Unassigned';
      const locations = state.practiceOverview.config.locations;
      const location = locations.find(loc => loc.id === id);
      return location ? `${location.name} (${location.id})` : id;
    }

    function getProviderName(id) {
      const providers = state.practiceOverview.config.providers;
      const provider = providers.find(item => item.id === id);
      return provider ? provider.name : id;
    }

    function getServiceWindowLabel(id) {
      const windows = state.practiceOverview.config.serviceWindows;
      const window = windows.find(item => item.id === id);
      return window ? window.label : id;
    }

    function renderAssets() {
      const tbody = document.getElementById('assets-body');
      const { assetSearch, assetStatusFilter, assetSort } = uiState;
      let assets = [...state.assets];
      if (assetSearch) {
        const term = assetSearch.trim().toLowerCase();
        assets = assets.filter(asset => {
          return [asset.id, asset.type, asset.model, getLocationName(asset.locationId)].some(value =>
            value && value.toLowerCase().includes(term)
          );
        });
      }
      if (assetStatusFilter !== 'All') {
        assets = assets.filter(asset => asset.status === assetStatusFilter);
      }
      if (assetSort.key) {
        assets.sort((a, b) => {
          const { key, direction } = assetSort;
          let valueA = a[key];
          let valueB = b[key];
          if (key === 'nextService') {
            valueA = valueA ? new Date(valueA).getTime() : Infinity;
            valueB = valueB ? new Date(valueB).getTime() : Infinity;
          }
          if (valueA === null || valueA === undefined) valueA = direction === 'asc' ? Infinity : -Infinity;
          if (valueB === null || valueB === undefined) valueB = direction === 'asc' ? Infinity : -Infinity;
          if (valueA < valueB) return direction === 'asc' ? -1 : 1;
          if (valueA > valueB) return direction === 'asc' ? 1 : -1;
          return 0;
        });
      }
      tbody.innerHTML = assets
        .map(asset => {
          const isActive = uiState.activeAssetId === asset.id;
          return `<tr class="transition hover:bg-slate-50 ${isActive ? 'bg-blue-50/60' : ''}" data-asset-row="${asset.id}">
            <td class="px-4 py-3 text-sm font-semibold text-blue-600">
              <a href="#" data-asset-link="${asset.id}" class="focus-outline inline-flex items-center gap-2 text-blue-600 hover:text-blue-700">
                ${asset.id}
                <svg class="h-3 w-3" viewBox="0 0 16 16" aria-hidden="true"><path fill="currentColor" d="M8 1l1.41 1.41L4.83 7H15v2H4.83l4.58 4.59L8 15l-7-7z"/></svg>
              </a>
            </td>
            <td class="px-4 py-3">
              <div class="font-medium text-slate-900">${asset.type}</div>
              <div class="text-xs text-slate-500">${asset.model}</div>
            </td>
            <td class="px-4 py-3 text-sm text-slate-600">${getLocationName(asset.locationId)}</td>
            <td class="px-4 py-3">
              <div class="flex items-center gap-2">
                <span class="${statusClasses(asset.status)}">${asset.status}</span>
                <button type="button" class="focus-outline inline-flex items-center gap-1 rounded-full border border-slate-300 px-3 py-1 text-xs font-semibold text-slate-600 transition hover:border-slate-400" data-report="${asset.id}">
                  <svg viewBox="0 0 20 20" class="h-3.5 w-3.5" aria-hidden="true"><path fill="currentColor" d="M10 2a2 2 0 00-2 2v5a2 2 0 002 2 2 2 0 002-2V4a2 2 0 00-2-2zm0 13a1.5 1.5 0 101.5 1.5A1.5 1.5 0 0010 15z"/></svg>
                  Report
                </button>
              </div>
            </td>
            <td class="px-4 py-3 text-sm text-slate-600">${formatDate(asset.nextService)}</td>
            <td class="px-4 py-3 text-sm text-slate-600">${formatDate(asset.warranty)}</td>
            <td class="px-4 py-3 text-right text-sm font-semibold text-slate-900">${formatCurrency(asset.spendYtd)}</td>
            <td class="px-4 py-3 text-right text-sm">
              <button type="button" data-asset-manage="${asset.id}" class="focus-outline inline-flex items-center gap-1 rounded-full border border-blue-200 px-3 py-1.5 text-xs font-semibold text-blue-600 transition hover:border-blue-300 hover:bg-blue-50">
                <svg viewBox="0 0 16 16" class="h-4 w-4" aria-hidden="true"><path fill="currentColor" d="M8 3a1 1 0 01.707.293l4 4a1 1 0 01-1.414 1.414L8 5.414 4.707 8.707A1 1 0 013.293 7.293l4-4A1 1 0 018 3z"/></svg>
                Manage
              </button>
            </td>
          </tr>`;
        })
        .join('');
      document.querySelectorAll('[data-sort-indicator]').forEach((indicator) => {
        const key = indicator.getAttribute('data-sort-indicator');
        if (uiState.assetSort.key === key) {
          indicator.textContent = uiState.assetSort.direction === 'asc' ? '‚Üë' : '‚Üì';
        } else {
          indicator.textContent = '‚Üï';
        }
      });
    }

    function renderAssetDetail() {
      const container = document.getElementById('asset-detail');
      const asset = state.assets.find(item => item.id === uiState.activeAssetId);
      if (!asset) {
        container.classList.add('hidden');
        container.innerHTML = '';
        return;
      }
      container.classList.remove('hidden');
      const locationLabel = asset.locationId ? getLocationName(asset.locationId) : 'Unassigned';
      const providerNames = (asset.serviceProviderIds || []).map(getProviderName);
      const windowLabels = (asset.serviceWindowIds || []).map(getServiceWindowLabel);
      const showSunset = asset.status === 'Sunset';
      const sunsetDisplay = showSunset
        ? asset.sunsetDate
          ? formatDate(asset.sunsetDate)
          : 'Sunset scheduled'
        : '';
      const tabs = [
        { id: 'profile', label: 'Profile' },
        { id: 'trending', label: 'Trending' },
        { id: 'spend', label: 'Spend' },
        { id: 'forecast', label: 'Forecast' },
        { id: 'playbook', label: 'Playbook' },
        { id: 'history', label: 'History' }
      ];
      if (!tabs.some(tab => tab.id === uiState.activeAssetTab)) {
        uiState.activeAssetTab = 'profile';
      }
      const width = 520;
      const height = 120;
      const trendingPath = buildSparklinePath(asset.trending, width, height, 10);
      const trendingArea = buildSparklineArea(asset.trending, width, height, 10);
      const providersContent = providerNames.length
        ? providerNames.map(name => `<li>${name}</li>`).join('')
        : '<li>Unassigned</li>';
      const windowsContent = windowLabels.length
        ? windowLabels.map(label => `<li>${label}</li>`).join('')
        : '<li>Unassigned</li>';
      const tabContent = {
        profile: `<div class="grid gap-4 md:grid-cols-2">
          <div class="rounded-2xl border border-slate-200 p-4">
            <p class="text-xs font-semibold uppercase tracking-widest text-slate-500">Room / Space</p>
            <p class="mt-2 text-sm font-medium text-slate-800">${locationLabel}</p>
          </div>
          <div class="rounded-2xl border border-slate-200 p-4">
            <p class="text-xs font-semibold uppercase tracking-widest text-slate-500">Preferred providers</p>
            <ul class="mt-2 space-y-1 text-sm text-slate-700">${providersContent}</ul>
          </div>
          <div class="rounded-2xl border border-slate-200 p-4">
            <p class="text-xs font-semibold uppercase tracking-widest text-slate-500">Service windows</p>
            <ul class="mt-2 space-y-1 text-sm text-slate-700">${windowsContent}</ul>
          </div>
          <div class="rounded-2xl border border-slate-200 p-4">
            <div>
              <p class="text-xs font-semibold uppercase tracking-widest text-slate-500">Next service</p>
              <p class="mt-1 text-sm font-medium text-slate-800">${formatDate(asset.nextService)}</p>
              <p class="text-xs text-slate-500">${relativeTimeFromNow(asset.nextService)}</p>
            </div>
            <div class="mt-3">
              <p class="text-xs font-semibold uppercase tracking-widest text-slate-500">Warranty</p>
              <p class="mt-1 text-sm font-medium text-slate-800">${formatDate(asset.warranty)}</p>
            </div>
            ${showSunset ? `<div class="mt-3"><p class="text-xs font-semibold uppercase tracking-widest text-slate-500">Sunset</p><p class="mt-1 text-sm font-medium text-amber-700">${sunsetDisplay}</p></div>` : ''}
          </div>
        </div>`,
        trending: `<div class="space-y-4">
          <div class="flex items-center gap-4 text-sm text-slate-500">
            <span class="font-medium text-slate-900">Utilization Trend</span>
            <span>Last 12 readings</span>
          </div>
          <svg viewBox="0 0 ${width} ${height}" class="h-32 w-full" role="img" aria-label="Asset utilization trend">
            <desc>Asset utilization sparkline with 12 data points</desc>
            <path d="${trendingArea}" class="sparkline-area fill-blue-500/15"></path>
            <path d="${trendingPath}" class="sparkline-path stroke-blue-600"></path>
          </svg>
          <div class="flex items-center gap-6 text-xs text-slate-500">
            <span class="inline-flex items-center gap-2"><span class="h-2 w-2 rounded-full bg-blue-600"></span>Performance index</span>
            <span>Range ${Math.min(...asset.trending)} - ${Math.max(...asset.trending)}</span>
          </div>
        </div>`,
        spend: `<div class="grid gap-4 sm:grid-cols-2">
          <div class="rounded-2xl border border-slate-200 p-4">
            <h3 class="text-sm font-medium text-slate-500">Year-to-date</h3>
            <p class="mt-2 text-2xl font-semibold text-slate-900">${formatCurrency(asset.spend.ytd)}</p>
          </div>
          <div class="rounded-2xl border border-slate-200 p-4">
            <h3 class="text-sm font-medium text-slate-500">Month-to-date</h3>
            <p class="mt-2 text-2xl font-semibold text-slate-900">${formatCurrency(asset.spend.mtd)}</p>
          </div>
        </div>`,
        forecast: `<div class="grid gap-4 sm:grid-cols-2">
          <div class="rounded-2xl border border-slate-200 p-4">
            <h3 class="text-sm font-medium text-slate-500">30-day projection</h3>
            <p class="mt-2 text-2xl font-semibold text-slate-900">${formatCurrency(asset.forecast['30'])}</p>
          </div>
          <div class="rounded-2xl border border-slate-200 p-4">
            <h3 class="text-sm font-medium text-slate-500">90-day projection</h3>
            <p class="mt-2 text-2xl font-semibold text-slate-900">${formatCurrency(asset.forecast['90'])}</p>
          </div>
        </div>`,
        playbook: `<ul class="list-disc space-y-2 pl-5 text-sm text-slate-600">
          ${asset.playbook.map(step => `<li>${step}</li>`).join('')}
        </ul>`,
        history: `<ul class="space-y-3 text-sm text-slate-600">
          ${asset.history.map(event => `<li class="rounded-2xl border border-slate-200 p-3">
            <div class="flex items-center justify-between text-xs text-slate-500">
              <span>${formatDate(event.date)}</span>
              <span class="font-semibold uppercase tracking-widest text-slate-400">${event.type}</span>
            </div>
            <p class="mt-1 font-medium text-slate-800">${event.summary}</p>
          </li>`).join('')}
        </ul>`
      };

      const locationLine = asset.locationId ? `Located in ${locationLabel}` : 'No room or space assigned';
      const sunsetLine = showSunset
        ? `Sunset ${asset.sunsetDate ? `effective ${sunsetDisplay}` : 'scheduled'}`
        : '';

      container.innerHTML = `
        <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
          <div>
            <h3 class="text-lg font-semibold text-slate-900">${asset.id}</h3>
            <p class="text-sm text-slate-500">${asset.type} ¬∑ ${asset.model}</p>
            <p class="text-xs text-slate-400">${locationLine}</p>
            ${sunsetLine ? `<p class="mt-1 text-xs font-semibold text-amber-600">${sunsetLine}</p>` : ''}
          </div>
          <div class="flex items-center gap-2">
            <span class="${statusClasses(asset.status)}">${asset.status}</span>
            <button type="button" class="focus-outline inline-flex items-center gap-2 rounded-full border border-slate-300 px-4 py-1.5 text-xs font-semibold text-slate-600" data-report="${asset.id}">
              <svg viewBox="0 0 20 20" class="h-4 w-4" aria-hidden="true"><path fill="currentColor" d="M10 2a2 2 0 00-2 2v5a2 2 0 002 2 2 2 0 002-2V4a2 2 0 00-2-2zm0 13a1.5 1.5 0 101.5 1.5A1.5 1.5 0 0010 15z"/></svg>
              Report event
            </button>
          </div>
        </div>
        <div class="mt-4">
          <div class="flex flex-wrap gap-2" role="tablist" aria-label="Asset detail tabs">
            ${tabs
              .map(tab => `<button type="button" role="tab" aria-selected="${uiState.activeAssetTab === tab.id}" data-asset-tab="${tab.id}" class="focus-outline rounded-full px-4 py-2 text-sm font-semibold ${uiState.activeAssetTab === tab.id ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}">${tab.label}</button>`)
              .join('')}
          </div>
          <div class="mt-6" role="tabpanel">${tabContent[uiState.activeAssetTab]}</div>
        </div>
      `;
    }

    function openDrawer(key) {
      const drawer = document.querySelector(`[data-drawer="${key}"]`);
      if (!drawer) return;
      drawer.classList.remove('hidden');
      drawer.setAttribute('aria-hidden', 'false');
      drawer.classList.remove('pointer-events-none');
      const backdrop = drawer.querySelector('[data-drawer-backdrop]');
      const panel = drawer.querySelector('[data-drawer-panel]');
      requestAnimationFrame(() => {
        backdrop.classList.add('opacity-100');
        panel.classList.remove('drawer-enter');
        panel.classList.add('drawer-open');
      });
      const close = () => closeDrawer(key);
      backdrop.addEventListener('click', close, { once: true });
      drawer.querySelectorAll('[data-close-drawer]').forEach(btn => btn.addEventListener('click', close, { once: true }));
      focusTrap.trap(panel, close);
      activeDrawerKey = key;
      renderDrawerContent(key);
    }

    function closeDrawer(key) {
      const drawer = document.querySelector(`[data-drawer="${key}"]`);
      if (!drawer) return;
      const backdrop = drawer.querySelector('[data-drawer-backdrop]');
      const panel = drawer.querySelector('[data-drawer-panel]');
      backdrop.classList.remove('opacity-100');
      panel.classList.remove('drawer-open');
      panel.classList.add('drawer-enter');
      setTimeout(() => {
        drawer.classList.add('hidden');
        drawer.classList.add('pointer-events-none');
        drawer.setAttribute('aria-hidden', 'true');
      }, 200);
      focusTrap.release();
      if (key === 'asset-management') {
        uiState.assetDrawer = { mode: null, assetId: null };
      }
      activeDrawerKey = null;
    }

    function openModal(assetId) {
      const modal = document.getElementById('downtime-modal');
      modal.classList.remove('hidden');
      modal.classList.remove('pointer-events-none');
      const backdrop = modal.querySelector('[data-modal-backdrop]');
      const panel = modal.querySelector('.modal-enter');
      const form = modal.querySelector('#downtime-form');
      form.assetId.value = assetId;
      const now = new Date();
      form.startTime.value = now.toISOString().slice(0, 16);
      form.symptom.value = '';
      form.emergency.checked = false;
      form.notify.checked = false;
      requestAnimationFrame(() => {
        backdrop.classList.add('opacity-100');
        panel.classList.add('modal-open');
      });
      const close = () => closeModal();
      backdrop.addEventListener('click', close, { once: true });
      modal.querySelectorAll('[data-close-modal]').forEach(btn => btn.addEventListener('click', close, { once: true }));
      focusTrap.trap(panel, close);
      activeModal = modal;
    }

    function closeModal() {
      if (!activeModal) return;
      const modal = activeModal;
      const backdrop = modal.querySelector('[data-modal-backdrop]');
      const panel = modal.querySelector('.modal-enter');
      backdrop.classList.remove('opacity-100');
      panel.classList.remove('modal-open');
      setTimeout(() => {
        modal.classList.add('hidden');
        modal.classList.add('pointer-events-none');
      }, 180);
      focusTrap.release();
      activeModal = null;
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.remove('hidden');
      toast.style.opacity = '1';
      toast.style.transform = 'translateY(0)';
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(12px)';
        setTimeout(() => {
          toast.classList.add('hidden');
        }, 200);
      }, 2600);
    }

    function renderDrawerContent(key) {
      if (key === 'locations') {
        renderLocationsDrawer();
      } else if (key === 'providers') {
        renderProvidersDrawer();
      } else if (key === 'service-windows') {
        renderServiceWindowsDrawer();
      } else if (key === 'asset-management') {
        renderAssetDrawer();
      }
    }

    function renderLocationsDrawer() {
      const container = document.getElementById('locations-drawer-content');
      const { adding, editing } = uiState;
      const addForm = adding.locations
        ? `<form data-location-form="add" class="mb-6 space-y-4 rounded-2xl border border-blue-100 bg-blue-50/60 p-4">
            <h3 class="text-sm font-semibold text-blue-700">Add room/space</h3>
            <label class="block text-sm font-medium text-slate-600">Identifier
              <input name="id" required class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" />
            </label>
            <label class="block text-sm font-medium text-slate-600">Display name
              <input name="name" required class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" />
            </label>
            <label class="block text-sm font-medium text-slate-600">Notes
              <textarea name="notes" rows="2" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200"></textarea>
            </label>
            <div class="flex justify-end gap-3">
              <button type="button" data-cancel-add="locations" class="focus-outline rounded-full border border-slate-300 px-4 py-2 text-xs font-semibold text-slate-600">Cancel</button>
              <button type="submit" class="focus-outline rounded-full bg-blue-600 px-4 py-2 text-xs font-semibold text-white">Save</button>
            </div>
          </form>`
        : `<button type="button" data-add="locations" class="focus-outline mb-6 inline-flex items-center gap-2 rounded-full border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-600 hover:border-slate-400"><span aria-hidden="true">Ôºã</span>Add room/space</button>`;

      const items = state.practiceOverview.config.locations
        .map((location) => {
          const isEditing = editing.locations === location.id;
          return `<article class="mb-4 rounded-2xl border border-slate-200 p-4 shadow-sm">
            <div class="flex items-start justify-between gap-4">
              <div>
                <p class="text-sm font-semibold text-slate-900">${location.name}</p>
                <p class="text-xs uppercase tracking-widest text-slate-400">${location.id}</p>
                <p class="mt-2 text-sm text-slate-600">${location.notes || '‚Äî'}</p>
              </div>
              <div class="flex gap-2">
                <button type="button" data-edit-location="${location.id}" class="focus-outline rounded-full border border-slate-300 px-3 py-1 text-xs font-semibold text-slate-600">Edit</button>
                <button type="button" data-remove-location="${location.id}" class="focus-outline rounded-full border border-rose-200 px-3 py-1 text-xs font-semibold text-rose-600">Remove</button>
              </div>
            </div>
            <form data-location-form="${location.id}" class="${isEditing ? '' : 'hidden'} mt-4 space-y-3 rounded-2xl border border-blue-100 bg-blue-50/60 p-4">
              <label class="block text-xs font-semibold uppercase tracking-widest text-slate-500">Identifier
                <input name="id" value="${location.id}" required class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" />
              </label>
              <label class="block text-xs font-semibold uppercase tracking-widest text-slate-500">Display name
                <input name="name" value="${location.name}" required class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" />
              </label>
              <label class="block text-xs font-semibold uppercase tracking-widest text-slate-500">Notes
                <textarea name="notes" rows="2" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200">${location.notes || ''}</textarea>
              </label>
              <div class="flex justify-end gap-3">
                <button type="button" data-cancel-edit="locations" class="focus-outline rounded-full border border-slate-300 px-4 py-1.5 text-xs font-semibold text-slate-600">Cancel</button>
                <button type="submit" class="focus-outline rounded-full bg-blue-600 px-4 py-1.5 text-xs font-semibold text-white">Save changes</button>
              </div>
            </form>
          </article>`;
        })
        .join('');

      container.innerHTML = `${addForm}${items || '<p class="text-sm text-slate-500">No rooms/spaces configured.</p>'}`;
    }

    function renderProvidersDrawer() {
      const container = document.getElementById('providers-drawer-content');
      const { adding, editing } = uiState;
      const addForm = adding.providers
        ? `<form data-provider-form="add" class="mb-6 space-y-4 rounded-2xl border border-blue-100 bg-blue-50/60 p-4">
            <h3 class="text-sm font-semibold text-blue-700">Add provider</h3>
            <div class="grid gap-3 sm:grid-cols-2">
              <label class="text-sm font-medium text-slate-600">Provider name
                <input name="name" required class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" />
              </label>
              <label class="text-sm font-medium text-slate-600">Priority
                <input type="number" name="priority" min="1" required class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" />
              </label>
            </div>
            <label class="text-sm font-medium text-slate-600">Coverage
              <input name="coverage" required class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" />
            </label>
            <label class="text-sm font-medium text-slate-600">Terms
              <textarea name="terms" rows="2" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200"></textarea>
            </label>
            <div class="flex justify-end gap-3">
              <button type="button" data-cancel-add="providers" class="focus-outline rounded-full border border-slate-300 px-4 py-2 text-xs font-semibold text-slate-600">Cancel</button>
              <button type="submit" class="focus-outline rounded-full bg-blue-600 px-4 py-2 text-xs font-semibold text-white">Save</button>
            </div>
          </form>`
        : `<button type="button" data-add="providers" class="focus-outline mb-6 inline-flex items-center gap-2 rounded-full border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-600 hover:border-slate-400"><span aria-hidden="true">Ôºã</span>Add provider</button>`;

      const items = state.practiceOverview.config.providers
        .sort((a, b) => a.priority - b.priority)
        .map((provider) => {
          const isEditing = editing.providers === provider.id;
          return `<article class="mb-4 rounded-2xl border border-slate-200 p-4 shadow-sm">
            <div class="flex items-start justify-between gap-4">
              <div>
                <p class="text-sm font-semibold text-slate-900">${provider.name}</p>
                <p class="text-xs uppercase tracking-widest text-slate-400">Priority ${provider.priority}</p>
                <p class="mt-2 text-sm text-slate-600">Coverage: ${provider.coverage}</p>
                <p class="mt-1 text-xs text-slate-500">${provider.terms || '‚Äî'}</p>
              </div>
              <div class="flex gap-2">
                <button type="button" data-edit-provider="${provider.id}" class="focus-outline rounded-full border border-slate-300 px-3 py-1 text-xs font-semibold text-slate-600">Edit</button>
                <button type="button" data-remove-provider="${provider.id}" class="focus-outline rounded-full border border-rose-200 px-3 py-1 text-xs font-semibold text-rose-600">Remove</button>
              </div>
            </div>
            <form data-provider-form="${provider.id}" class="${isEditing ? '' : 'hidden'} mt-4 space-y-3 rounded-2xl border border-blue-100 bg-blue-50/60 p-4">
              <div class="grid gap-3 sm:grid-cols-2">
                <label class="text-xs font-semibold uppercase tracking-widest text-slate-500">Provider name
                  <input name="name" value="${provider.name}" required class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" />
                </label>
                <label class="text-xs font-semibold uppercase tracking-widest text-slate-500">Priority
                  <input type="number" name="priority" min="1" value="${provider.priority}" required class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" />
                </label>
              </div>
              <label class="text-xs font-semibold uppercase tracking-widest text-slate-500">Coverage
                <input name="coverage" value="${provider.coverage}" required class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" />
              </label>
              <label class="text-xs font-semibold uppercase tracking-widest text-slate-500">Terms
                <textarea name="terms" rows="2" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200">${provider.terms || ''}</textarea>
              </label>
              <div class="flex justify-end gap-3">
                <button type="button" data-cancel-edit="providers" class="focus-outline rounded-full border border-slate-300 px-4 py-1.5 text-xs font-semibold text-slate-600">Cancel</button>
                <button type="submit" class="focus-outline rounded-full bg-blue-600 px-4 py-1.5 text-xs font-semibold text-white">Save changes</button>
              </div>
            </form>
          </article>`;
        })
        .join('');

      container.innerHTML = `${addForm}${items || '<p class="text-sm text-slate-500">No providers configured.</p>'}`;
    }

    function renderServiceWindowsDrawer() {
      const container = document.getElementById('service-windows-drawer-content');
      const { adding, editing } = uiState;
      const addForm = adding.serviceWindows
        ? `<form data-service-window-form="add" class="mb-6 space-y-4 rounded-2xl border border-blue-100 bg-blue-50/60 p-4">
            <h3 class="text-sm font-semibold text-blue-700">Add service window</h3>
            <label class="text-sm font-medium text-slate-600">Label
              <input name="label" required class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" />
            </label>
            <label class="text-sm font-medium text-slate-600">RRULE
              <input name="rrule" required class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="FREQ=WEEKLY;..." />
            </label>
            <label class="text-sm font-medium text-slate-600">Blackout dates (one per line)
              <textarea name="blackouts" rows="3" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200"></textarea>
            </label>
            <div class="flex justify-end gap-3">
              <button type="button" data-cancel-add="serviceWindows" class="focus-outline rounded-full border border-slate-300 px-4 py-2 text-xs font-semibold text-slate-600">Cancel</button>
              <button type="submit" class="focus-outline rounded-full bg-blue-600 px-4 py-2 text-xs font-semibold text-white">Save</button>
            </div>
          </form>`
        : `<button type="button" data-add="serviceWindows" class="focus-outline mb-6 inline-flex items-center gap-2 rounded-full border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-600 hover:border-slate-400"><span aria-hidden="true">Ôºã</span>Add service window</button>`;

      const items = state.practiceOverview.config.serviceWindows
        .map((window) => {
          const isEditing = editing.serviceWindows === window.id;
          return `<article class="mb-4 rounded-2xl border border-slate-200 p-4 shadow-sm">
            <div class="flex items-start justify-between gap-4">
              <div>
                <p class="text-sm font-semibold text-slate-900">${window.label}</p>
                <p class="text-xs uppercase tracking-widest text-slate-400">${window.id}</p>
                <p class="mt-2 text-xs font-mono text-slate-500">${window.rrule}</p>
                <div class="mt-3 text-xs text-slate-500">
                  <p class="font-semibold text-slate-600">Blackout dates</p>
                  <ul class="list-disc pl-5">
                    ${window.blackouts.map(date => `<li>${date}</li>`).join('') || '<li>None</li>'}
                  </ul>
                </div>
              </div>
              <div class="flex gap-2">
                <button type="button" data-edit-service-window="${window.id}" class="focus-outline rounded-full border border-slate-300 px-3 py-1 text-xs font-semibold text-slate-600">Edit</button>
                <button type="button" data-remove-service-window="${window.id}" class="focus-outline rounded-full border border-rose-200 px-3 py-1 text-xs font-semibold text-rose-600">Remove</button>
              </div>
            </div>
            <form data-service-window-form="${window.id}" class="${isEditing ? '' : 'hidden'} mt-4 space-y-3 rounded-2xl border border-blue-100 bg-blue-50/60 p-4">
              <label class="text-xs font-semibold uppercase tracking-widest text-slate-500">Label
                <input name="label" value="${window.label}" required class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" />
              </label>
              <label class="text-xs font-semibold uppercase tracking-widest text-slate-500">RRULE
                <input name="rrule" value="${window.rrule}" required class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" />
              </label>
              <label class="text-xs font-semibold uppercase tracking-widest text-slate-500">Blackout dates (one per line)
                <textarea name="blackouts" rows="3" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200">${window.blackouts.join('\n')}</textarea>
              </label>
              <div class="flex justify-end gap-3">
                <button type="button" data-cancel-edit="serviceWindows" class="focus-outline rounded-full border border-slate-300 px-4 py-1.5 text-xs font-semibold text-slate-600">Cancel</button>
                <button type="submit" class="focus-outline rounded-full bg-blue-600 px-4 py-1.5 text-xs font-semibold text-white">Save changes</button>
              </div>
            </form>
          </article>`;
        })
        .join('');

      container.innerHTML = `${addForm}${items || '<p class="text-sm text-slate-500">No service windows configured.</p>'}`;
    }

    function renderAssetDrawer() {
      const root = document.getElementById('asset-drawer-root');
      if (!root) return;
      const { mode, assetId } = uiState.assetDrawer;
      const existingAsset = mode === 'edit' ? state.assets.find(item => item.id === assetId) : null;
      const isAdd = !existingAsset;
      if (mode === 'edit' && !existingAsset) {
        uiState.assetDrawer = { mode: 'add', assetId: null };
      }
      const asset = existingAsset
        ? {
            ...existingAsset,
            spend: { ...existingAsset.spend },
            forecast: { ...existingAsset.forecast },
            playbook: [...(existingAsset.playbook || [])],
            serviceProviderIds: [...(existingAsset.serviceProviderIds || [])],
            serviceWindowIds: [...(existingAsset.serviceWindowIds || [])]
          }
        : {
            id: '',
            type: '',
            model: '',
            locationId: '',
            status: 'Healthy',
            nextService: '',
            warranty: '',
            spendYtd: 0,
            spend: { ytd: 0, mtd: 0 },
            forecast: { '30': 0, '90': 0 },
            playbook: [],
            serviceProviderIds: [],
            serviceWindowIds: [],
            sunsetDate: null
          };
      if (existingAsset) {
        uiState.assetDrawer.assetId = existingAsset.id;
      }
      const locations = state.practiceOverview.config.locations;
      const providers = state.practiceOverview.config.providers;
      const serviceWindows = state.practiceOverview.config.serviceWindows;
      const statusOptions = ['Healthy', 'Attention', 'Down', 'Unknown', 'Sunset'];
      const spendYtd = asset.spend?.ytd ?? asset.spendYtd ?? 0;
      const spendMtd = asset.spend?.mtd ?? 0;
      const forecast30 = asset.forecast?.['30'] ?? 0;
      const forecast90 = asset.forecast?.['90'] ?? 0;
      const playbookValue = asset.playbook.join('\n');
      const providerList = providers.length
        ? `<div class="space-y-2">${providers
            .map((provider) => {
              const checked = asset.serviceProviderIds.includes(provider.id) ? 'checked' : '';
              return `<label class="flex items-start gap-3 rounded-2xl border border-slate-200 px-3 py-3 text-sm text-slate-600">
                <input type="checkbox" name="asset-providers" value="${provider.id}" ${checked} class="mt-1 h-4 w-4 rounded border-slate-300 text-blue-500 focus:ring-blue-200" />
                <span>
                  <span class="block font-semibold text-slate-700">${provider.name}</span>
                  <span class="block text-xs text-slate-400">Priority ${provider.priority} ¬∑ ${provider.coverage}</span>
                </span>
              </label>`;
            })
            .join('')}</div>`
        : '<p class="text-sm text-slate-500">No providers configured.</p>';
      const windowList = serviceWindows.length
        ? `<div class="space-y-2">${serviceWindows
            .map((window) => {
              const checked = asset.serviceWindowIds.includes(window.id) ? 'checked' : '';
              return `<label class="flex items-start gap-3 rounded-2xl border border-slate-200 px-3 py-3 text-sm text-slate-600">
                <input type="checkbox" name="asset-windows" value="${window.id}" ${checked} class="mt-1 h-4 w-4 rounded border-slate-300 text-blue-500 focus:ring-blue-200" />
                <span>
                  <span class="block font-semibold text-slate-700">${window.label}</span>
                  <span class="block text-xs text-slate-400">${window.rrule}</span>
                </span>
              </label>`;
            })
            .join('')}</div>`
        : '<p class="text-sm text-slate-500">No service windows configured.</p>';
      const title = isAdd ? 'Add asset' : `Manage ${asset.id}`;
      const subtitle = isAdd
        ? 'Register equipment and connect it to rooms, providers, and service windows.'
        : `${asset.type || 'Asset'}${asset.model ? ` ‚Ä¢ ${asset.model}` : ''}`;
      const lifecycleAction = existingAsset
        ? existingAsset.status === 'Sunset'
          ? `<button type="button" data-asset-reactivate class="focus-outline inline-flex items-center gap-2 rounded-full border border-emerald-200 px-4 py-2 text-xs font-semibold text-emerald-700 transition hover:border-emerald-300 hover:bg-emerald-50">Reactivate asset</button>`
          : `<button type="button" data-asset-sunset class="focus-outline inline-flex items-center gap-2 rounded-full border border-rose-200 px-4 py-2 text-xs font-semibold text-rose-600 transition hover:border-rose-300 hover:bg-rose-50">Sunset asset</button>`
        : '<p class="text-xs text-slate-400">Relationships can be adjusted after you save.</p>';

      root.innerHTML = `
        <div class="flex items-start justify-between border-b border-slate-200 px-6 py-5">
          <div>
            <h2 class="text-lg font-semibold text-slate-900">${title}</h2>
            <p class="text-sm text-slate-500">${subtitle}</p>
          </div>
          <button type="button" class="focus-outline rounded-full border border-transparent p-2 text-slate-400 hover:text-slate-600" data-close-drawer>
            <span class="sr-only">Close</span>
            <svg viewBox="0 0 24 24" class="h-5 w-5" aria-hidden="true"><path fill="currentColor" d="M18.3 5.71a1 1 0 00-1.41 0L12 10.59 7.11 5.7A1 1 0 105.7 7.11L10.59 12l-4.9 4.89a1 1 0 101.41 1.41L12 13.41l4.89 4.9a1 1 0 001.41-1.42L13.41 12l4.9-4.89a1 1 0 000-1.4z"/></svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto px-6 py-6">
          <form data-asset-form="${isAdd ? 'add' : asset.id}" class="space-y-6">
            <section class="space-y-4">
              <div class="grid gap-4 sm:grid-cols-2">
                <label class="text-sm font-medium text-slate-600">Asset ID
                  <input name="asset-id" value="${asset.id}" required class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" />
                </label>
                <label class="text-sm font-medium text-slate-600">Asset type
                  <input name="asset-type" value="${asset.type}" required class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" />
                </label>
              </div>
              <label class="text-sm font-medium text-slate-600">Model
                <input name="asset-model" value="${asset.model}" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" />
              </label>
            </section>

            <section class="grid gap-4 sm:grid-cols-2">
              <label class="text-sm font-medium text-slate-600">Room / space
                <select name="asset-location" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200">
                  <option value="" ${asset.locationId ? '' : 'selected'}>Unassigned</option>
                  ${locations
                    .map(location => `<option value="${location.id}" ${asset.locationId === location.id ? 'selected' : ''}>${location.name} (${location.id})</option>`)
                    .join('')}
                </select>
              </label>
              <label class="text-sm font-medium text-slate-600">Status
                <select name="asset-status" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200">
                  ${statusOptions
                    .map(status => `<option value="${status}" ${asset.status === status ? 'selected' : ''}>${status}</option>`)
                    .join('')}
                </select>
              </label>
              <label class="text-sm font-medium text-slate-600">Next service
                <input type="date" name="asset-next-service" value="${toDateInputValue(asset.nextService)}" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" />
              </label>
              <label class="text-sm font-medium text-slate-600">Warranty expiration
                <input type="date" name="asset-warranty" value="${toDateInputValue(asset.warranty)}" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" />
              </label>
            </section>

            <section class="grid gap-4 sm:grid-cols-2">
              <label class="text-sm font-medium text-slate-600">Spend YTD
                <input type="number" step="1" min="0" name="asset-spend-ytd" value="${spendYtd}" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" />
              </label>
              <label class="text-sm font-medium text-slate-600">Spend MTD
                <input type="number" step="1" min="0" name="asset-spend-mtd" value="${spendMtd}" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" />
              </label>
              <label class="text-sm font-medium text-slate-600">Forecast 30 days
                <input type="number" step="1" min="0" name="asset-forecast-30" value="${forecast30}" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" />
              </label>
              <label class="text-sm font-medium text-slate-600">Forecast 90 days
                <input type="number" step="1" min="0" name="asset-forecast-90" value="${forecast90}" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" />
              </label>
            </section>

            <label class="block text-sm font-medium text-slate-600">Playbook steps (one per line)
              <textarea name="asset-playbook" rows="3" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200">${playbookValue}</textarea>
            </label>

            <section class="space-y-3">
              <h3 class="text-sm font-semibold text-slate-700">Service providers</h3>
              ${providerList}
            </section>

            <section class="space-y-3">
              <h3 class="text-sm font-semibold text-slate-700">Service windows</h3>
              ${windowList}
            </section>

            <div class="flex flex-col gap-3 border-t border-slate-200 pt-4 sm:flex-row sm:items-center sm:justify-between">
              ${lifecycleAction}
              <div class="flex gap-3">
                <button type="button" data-close-drawer class="focus-outline rounded-full border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-600">Cancel</button>
                <button type="submit" class="focus-outline inline-flex items-center gap-2 rounded-full bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700">Save asset</button>
              </div>
            </div>
          </form>
        </div>
      `;
    }

    function handleDrawerInteractions(event) {
      const target = event.target;
      if (target.matches('[data-add]')) {
        const key = target.getAttribute('data-add');
        uiState.adding[key] = true;
        renderDrawerContent(key === 'serviceWindows' ? 'service-windows' : key);
      }
      if (target.matches('[data-cancel-add]')) {
        const key = target.getAttribute('data-cancel-add');
        uiState.adding[key] = false;
        renderDrawerContent(key === 'serviceWindows' ? 'service-windows' : key);
      }
      if (target.matches('[data-edit-location]')) {
        uiState.editing.locations = target.getAttribute('data-edit-location');
        renderLocationsDrawer();
      }
      if (target.matches('[data-edit-provider]')) {
        uiState.editing.providers = target.getAttribute('data-edit-provider');
        renderProvidersDrawer();
      }
      if (target.matches('[data-edit-service-window]')) {
        uiState.editing.serviceWindows = target.getAttribute('data-edit-service-window');
        renderServiceWindowsDrawer();
      }
      if (target.matches('[data-cancel-edit]')) {
        const key = target.getAttribute('data-cancel-edit');
        uiState.editing[key === 'serviceWindows' ? 'serviceWindows' : key] = null;
        renderDrawerContent(key === 'serviceWindows' ? 'service-windows' : key);
      }
      if (target.matches('[data-remove-location]')) {
        const id = target.getAttribute('data-remove-location');
        state.practiceOverview.config.locations = state.practiceOverview.config.locations.filter(loc => loc.id !== id);
        uiState.editing.locations = null;
        renderLocationsDrawer();
        renderAssets();
        renderAssetDetail();
      }
      if (target.matches('[data-remove-provider]')) {
        const id = target.getAttribute('data-remove-provider');
        state.practiceOverview.config.providers = state.practiceOverview.config.providers.filter(prov => prov.id !== id);
        uiState.editing.providers = null;
        renderProvidersDrawer();
      }
      if (target.matches('[data-remove-service-window]')) {
        const id = target.getAttribute('data-remove-service-window');
        state.practiceOverview.config.serviceWindows = state.practiceOverview.config.serviceWindows.filter(win => win.id !== id);
        uiState.editing.serviceWindows = null;
        renderServiceWindowsDrawer();
      }
      if (target.matches('[data-asset-sunset]')) {
        const { assetId } = uiState.assetDrawer;
        const asset = state.assets.find(item => item.id === assetId);
        if (asset) {
          asset.previousStatus = asset.status;
          asset.status = 'Sunset';
          asset.sunsetDate = new Date().toISOString().slice(0, 10);
          renderAssets();
          renderAssetDetail();
          renderAssetDrawer();
          showToast(`${asset.id} scheduled for sunset`);
        }
      }
      if (target.matches('[data-asset-reactivate]')) {
        const { assetId } = uiState.assetDrawer;
        const asset = state.assets.find(item => item.id === assetId);
        if (asset) {
          const restored = asset.previousStatus && asset.previousStatus !== 'Sunset' ? asset.previousStatus : 'Healthy';
          asset.status = restored;
          asset.sunsetDate = null;
          asset.previousStatus = null;
          renderAssets();
          renderAssetDetail();
          renderAssetDrawer();
          showToast(`${asset.id} reactivated`);
        }
      }
    }

    function handleDrawerFormSubmit(event) {
      const form = event.target.closest('form');
      if (!form) return;
      const locationFormKey = form.getAttribute('data-location-form');
      const providerFormKey = form.getAttribute('data-provider-form');
      const serviceWindowFormKey = form.getAttribute('data-service-window-form');
      const assetFormKey = form.getAttribute('data-asset-form');

      if (locationFormKey) {
        event.preventDefault();
        const formData = new FormData(form);
        const newLocation = {
          id: formData.get('id').trim(),
          name: formData.get('name').trim(),
          notes: formData.get('notes').trim()
        };
        if (!newLocation.id || !newLocation.name) return;
        if (locationFormKey === 'add') {
          state.practiceOverview.config.locations.push(newLocation);
          uiState.adding.locations = false;
        } else {
          const index = state.practiceOverview.config.locations.findIndex(loc => loc.id === locationFormKey);
          if (index > -1) {
            state.practiceOverview.config.locations[index] = newLocation;
          }
          uiState.editing.locations = null;
        }
        renderLocationsDrawer();
        renderAssets();
        renderAssetDetail();
      }

      if (providerFormKey) {
        event.preventDefault();
        const formData = new FormData(form);
        const updated = {
          id: providerFormKey === 'add' ? `prov-${crypto.randomUUID().slice(0, 6)}` : providerFormKey,
          name: formData.get('name').trim(),
          priority: Number(formData.get('priority')),
          coverage: formData.get('coverage').trim(),
          terms: formData.get('terms').trim()
        };
        if (!updated.name || Number.isNaN(updated.priority)) return;
        if (providerFormKey === 'add') {
          state.practiceOverview.config.providers.push(updated);
          uiState.adding.providers = false;
        } else {
          const index = state.practiceOverview.config.providers.findIndex(prov => prov.id === providerFormKey);
          if (index > -1) {
            state.practiceOverview.config.providers[index] = updated;
          }
          uiState.editing.providers = null;
        }
        renderProvidersDrawer();
      }

      if (serviceWindowFormKey) {
        event.preventDefault();
        const formData = new FormData(form);
        const blackoutValue = formData.get('blackouts');
        const blackouts = blackoutValue
          ? blackoutValue.split(/\n|,/).map(item => item.trim()).filter(Boolean)
          : [];
        const updated = {
          id: serviceWindowFormKey === 'add' ? `svc-${crypto.randomUUID().slice(0, 6)}` : serviceWindowFormKey,
          label: formData.get('label').trim(),
          rrule: formData.get('rrule').trim(),
          blackouts
        };
        if (!updated.label || !updated.rrule) return;
        if (serviceWindowFormKey === 'add') {
          state.practiceOverview.config.serviceWindows.push(updated);
          uiState.adding.serviceWindows = false;
        } else {
          const index = state.practiceOverview.config.serviceWindows.findIndex(win => win.id === serviceWindowFormKey);
          if (index > -1) {
            state.practiceOverview.config.serviceWindows[index] = updated;
          }
          uiState.editing.serviceWindows = null;
        }
        renderServiceWindowsDrawer();
      }

      if (assetFormKey) {
        event.preventDefault();
        const formData = new FormData(form);
        const id = (formData.get('asset-id') || '').trim();
        const type = (formData.get('asset-type') || '').trim();
        if (!id || !type) return;
        const model = (formData.get('asset-model') || '').trim();
        const locationId = formData.get('asset-location') || '';
        const status = formData.get('asset-status') || 'Healthy';
        const nextServiceRaw = formData.get('asset-next-service');
        const warrantyRaw = formData.get('asset-warranty');
        const spendYtdValue = Number.parseFloat(formData.get('asset-spend-ytd') || '0');
        const spendMtdValue = Number.parseFloat(formData.get('asset-spend-mtd') || '0');
        const forecast30Value = Number.parseFloat(formData.get('asset-forecast-30') || '0');
        const forecast90Value = Number.parseFloat(formData.get('asset-forecast-90') || '0');
        const playbookRaw = formData.get('asset-playbook') || '';
        const sanitizeNumber = (value) => (Number.isFinite(value) ? Math.max(0, value) : 0);
        const spendYtd = sanitizeNumber(spendYtdValue);
        const spendMtd = sanitizeNumber(spendMtdValue);
        const forecast30 = sanitizeNumber(forecast30Value);
        const forecast90 = sanitizeNumber(forecast90Value);
        const playbook = playbookRaw
          ? playbookRaw.split(/\n+/).map(item => item.trim()).filter(Boolean)
          : [];
        const serviceProviderIds = Array.from(form.querySelectorAll('input[name="asset-providers"]:checked')).map(input => input.value);
        const serviceWindowIds = Array.from(form.querySelectorAll('input[name="asset-windows"]:checked')).map(input => input.value);
        const nextService = nextServiceRaw ? nextServiceRaw : null;
        const warranty = warrantyRaw ? warrantyRaw : null;

        if (assetFormKey === 'add') {
          const newAsset = {
            id,
            type,
            model,
            locationId: locationId || '',
            status,
            nextService,
            warranty,
            spendYtd,
            spend: { ytd: spendYtd, mtd: spendMtd },
            forecast: { '30': forecast30, '90': forecast90 },
            playbook,
            serviceProviderIds,
            serviceWindowIds,
            trending: generateTrendingFromStatus(status),
            history: [],
            sunsetDate: status === 'Sunset' ? new Date().toISOString().slice(0, 10) : null,
            previousStatus: status === 'Sunset' ? 'Healthy' : null
          };
          state.assets.unshift(newAsset);
          uiState.assetDrawer = { mode: 'edit', assetId: newAsset.id };
          uiState.activeAssetId = newAsset.id;
        } else {
          const index = state.assets.findIndex(item => item.id === assetFormKey);
          if (index > -1) {
            const existing = state.assets[index];
            const updated = {
              ...existing,
              id,
              type,
              model,
              locationId: locationId || '',
              status,
              nextService,
              warranty,
              spendYtd,
              spend: { ytd: spendYtd, mtd: spendMtd },
              forecast: { '30': forecast30, '90': forecast90 },
              playbook,
              serviceProviderIds,
              serviceWindowIds,
              trending: existing.trending && existing.trending.length ? existing.trending : generateTrendingFromStatus(status),
              history: existing.history || []
            };
            if (existing.status !== 'Sunset' && status === 'Sunset') {
              updated.previousStatus = existing.status;
              updated.sunsetDate = new Date().toISOString().slice(0, 10);
            } else if (status !== 'Sunset') {
              updated.previousStatus = null;
              updated.sunsetDate = null;
            }
            if (status === 'Sunset' && !updated.sunsetDate) {
              updated.sunsetDate = new Date().toISOString().slice(0, 10);
            }
            state.assets[index] = updated;
            uiState.assetDrawer.assetId = updated.id;
            if (uiState.activeAssetId === existing.id) {
              uiState.activeAssetId = updated.id;
            }
          }
        }
        renderAssets();
        renderAssetDetail();
        showToast(`${id} saved`);
        closeDrawer('asset-management');
      }
    }

    function bindEvents() {
      document.querySelectorAll('[data-open-drawer]').forEach((button) => {
        button.addEventListener('click', () => {
          const key = button.getAttribute('data-open-drawer');
          openDrawer(key);
        });
      });

      document.getElementById('asset-search').addEventListener('input', (event) => {
        uiState.assetSearch = event.target.value;
        renderAssets();
      });

      document.getElementById('status-filter').addEventListener('change', (event) => {
        uiState.assetStatusFilter = event.target.value;
        renderAssets();
      });

      document.querySelectorAll('[data-sort]').forEach((button) => {
        button.addEventListener('click', () => {
          const key = button.getAttribute('data-sort');
          if (uiState.assetSort.key === key) {
            uiState.assetSort.direction = uiState.assetSort.direction === 'asc' ? 'desc' : 'asc';
          } else {
            uiState.assetSort.key = key;
            uiState.assetSort.direction = 'asc';
          }
          renderAssets();
        });
      });

      const addAssetButton = document.querySelector('[data-asset-add]');
      if (addAssetButton) {
        addAssetButton.addEventListener('click', () => {
          uiState.assetDrawer = { mode: 'add', assetId: null };
          openDrawer('asset-management');
        });
      }

      document.getElementById('assets-body').addEventListener('click', (event) => {
        const link = event.target.closest('[data-asset-link]');
        const manage = event.target.closest('[data-asset-manage]');
        const report = event.target.closest('[data-report]');
        if (link) {
          event.preventDefault();
          uiState.activeAssetId = link.getAttribute('data-asset-link');
          uiState.activeAssetTab = 'profile';
          renderAssets();
          renderAssetDetail();
          document.getElementById('asset-detail').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        if (manage) {
          const assetId = manage.getAttribute('data-asset-manage');
          uiState.activeAssetId = assetId;
          uiState.activeAssetTab = 'profile';
          renderAssets();
          renderAssetDetail();
          uiState.assetDrawer = { mode: 'edit', assetId };
          openDrawer('asset-management');
        }
        if (report) {
          const assetId = report.getAttribute('data-report');
          openModal(assetId);
        }
      });

      document.getElementById('asset-detail').addEventListener('click', (event) => {
        const tabButton = event.target.closest('[data-asset-tab]');
        const report = event.target.closest('[data-report]');
        if (tabButton) {
          uiState.activeAssetTab = tabButton.getAttribute('data-asset-tab');
          renderAssetDetail();
        }
        if (report) {
          const assetId = report.getAttribute('data-report');
          openModal(assetId);
        }
      });

      document.getElementById('downtime-form').addEventListener('submit', (event) => {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const assetId = formData.get('assetId');
        const asset = state.assets.find(item => item.id === assetId);
        if (!asset) return;
        const incident = {
          id: `inc-${crypto.randomUUID().slice(0, 6)}`,
          assetId,
          startTime: formData.get('startTime'),
          symptom: formData.get('symptom').trim(),
          impact: formData.get('impact'),
          emergency: formData.get('emergency') === 'on',
          notify: formData.get('notify') === 'on'
        };
        state.incidents.unshift(incident);
        asset.history.unshift({
          date: incident.startTime,
          summary: `Downtime logged: ${incident.symptom}`,
          type: incident.impact
        });
        if (asset.status === 'Healthy') {
          asset.status = 'Attention';
        }
        renderAssets();
        renderAssetDetail();
        closeModal();
        showToast(`Incident recorded for ${asset.id}`);
      });

      ['locations', 'providers', 'service-windows', 'asset-management'].forEach((key) => {
        const drawer = document.querySelector(`[data-drawer="${key}"]`);
        drawer.addEventListener('click', handleDrawerInteractions);
        drawer.addEventListener('submit', handleDrawerFormSubmit);
      });
    }

    function initialize() {
      refs.practiceName = document.getElementById('practice-name');
      refs.practiceName.textContent = state.practiceOverview.practiceName;
      refs.lastRefreshed = document.getElementById('last-refreshed');
      refs.lastRefreshed.textContent = new Date().toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit'
      });
      renderKPIs();
      renderTrends();
      renderAssets();
      renderAssetDetail();
      bindEvents();
    }

    let activeDrawerKey = null;
    let activeModal = null;

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        if (activeModal) {
          closeModal();
        } else if (activeDrawerKey) {
          closeDrawer(activeDrawerKey);
        }
      }
    });

    initialize();
  </script>
</body>
</html>
